---
layout: post
title: '砸壳&Theos'
subtitle: '砸壳、Theos'
date: 2018-03-28
categories: 技术
cover: 
tags: 逆向tz
---

#### 砸壳概述
* 拿到路径

<pre><code class="language-objectivec">$ ps -A
3083 ??         0:02.32 /var/mobile/Containers/Bundle/Application/2E792188-A786-43EA-A13A-78F27B6A38FD/Keep.app/Keep
</code></pre>

* 打开ifunbox拿到ipa拿到Macho
* 查看Macho文件是否被加密

<pre><code class="language-objectivec">$ otool -l Keep | grep crypt
    cryptoff 16384
    cryptsize 45711360
    cryptid 1//加密标识
</code></pre>

* 加壳的应用不能直接执行，操作系统才有解密方法

> 原理：MachO文件是明文，苹果加密后变成加壳文件。安装到手机，加壳文件跑在手机上，系统解密变成MachO文件，dyld加载MachO文件。砸壳？不知道解密方式？
> 

* 静态砸壳(Clutch)：直接调用解密程序，帮助砸壳，无需用户点击
* 动态砸壳(dumpdecrypted)：不知道解密程序，知道dyld会加载MachO，在启动加载MachO的那一刻从内存中拷出来

> DRM(数字版权管理)检查，检查通过，从App的可执行文件中，即MachO选择合适的架构用dyld加载，加载过程中操作系统会进行解密，使用dyld加载解密的MachO
> 解密工具不会做解密逻辑，只会遍历loadcommond信息，对应解密后的数据。从内存中dump出来然后生成新的MachO文件

#### [Clutch](https://github.com/KJCracks/Clutch/releases)

* 命令行工具

<pre><code class="language-objectivec">$ file Clutch-2.0.4
Clutch-2.0.4: Mach-O universal binary with 3 architectures: [arm_v7:Mach-O executable arm_v7] [arm64:Mach-O 64-bit executable arm64]
Clutch-2.0.4 (for architecture armv7):	Mach-O executable arm_v7
Clutch-2.0.4 (for architecture armv7s):	Mach-O executable arm_v7s
Clutch-2.0.4 (for architecture arm64):	Mach-O 64-bit executable arm64
</code></pre>

* 拷贝到手机，命令行都放到bin文件下(建议把版本后缀去掉)

<pre><code class="language-objectivec">$ scp -P 12345 Clutch root@localhost:/usr/bin
//改名
$ mv Clutch-2.0.4 Clutch
//执行权限
$ chmod +x Clutch
//查看加密的应用
$ Clutch -i
Installed apps:
1:   网易云音乐-音乐的力量 <com.netease.cloudmusic>
2:   王者荣耀 <com.tencent.smoba>
3:   Keep - 自由运动场 <com.gotokeep.keep>
//砸壳 Clutch -d 序号/bundleId
kumani:~ root# Clutch -d com.gotokeep.keep
//砸壳后的文件路径
DONE: /private/var/mobile/Documents/Dumped/com.gotokeep.keep-iOS8.0-(Clutch-2.0.4).ipa
//耗时
Finished dumping com.gotokeep.keep in 25.6 seconds
</code></pre>


