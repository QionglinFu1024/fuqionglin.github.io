---
layout: post
title: 'ä»£ç ç­¾å'
subtitle: 'ç­¾å'
date: 2018-03-12
categories: æŠ€æœ¯
cover: 
tags: é€†å‘tz
---

### RSA
* OpenSSL

<pre><code class="language-objectivec">//ç”Ÿæˆç§é’¥
$ openssl genrsa -out private.pem 512
Generating RSA private key, 512 bit long modulus
...++++++++++++
......++++++++++++
e is 65537 (0x10001)

//ä»ç§é’¥ç®—å‡ºå…¬é’¥
$ openssl rsa -in private.pem -out public.pem -pubout
writing RSA key

//æŸ¥çœ‹åŠ å¯†ä¿¡æ¯
$ openssl rsa -in private.pem -text -out private.txt
</code></pre>

* HASH å“ˆå¸Œ(æ•£åˆ—)å‡½æ•°
    * ä¸å¯é€†(ä¸èƒ½ç”¨äºåŠ å¯†&è§£å¯†)
    * ä¸€ä¸ªäºŒè¿›åˆ¶æ•°æ®ï¼Œåªæœ‰ä¸€ä¸ªHASHå€¼

* éå¯¹ç§° RSA (é•¿åº¦åœ¨200ä½ä»¥ä¸Šçš„æ•°å­—)
    * ç”±äºæ˜¯ç®€å•çš„æ•°å­¦è®¡ç®—ã€‚æ‰€ä»¥åŠ å¯†æ•ˆç‡æ¯”è¾ƒä½...æ‰€ä»¥ä¸€èˆ¬ç”¨äºåŠ å¯†æ ¸å¿ƒçš„(å°æ•°æ®)
    * å…¬é’¥åŠ å¯†ï¼Œç§é’¥è§£å¯†
    * ç§é’¥åŠ å¯†ï¼Œå…¬é’¥åŠ å¯†

### æ•°å­—ç­¾å

* å®¢æˆ·ç«¯ æ¶ˆè´¹Â¥10 å‘ç»™æœåŠ¡å™¨
![](https://fuqionglin-blog.oss-cn-qingdao.aliyuncs.com/%E6%BD%AD%E5%B7%9E/%E4%BB%A3%E7%A0%81%E7%AD%BE%E5%90%8D/01.jpg)

* ä¼ é€’çš„æ˜¯äºŒè¿›åˆ¶ã€‚æ— æ³•ä¿è¯æ˜¯å¦è¢«ä¿®æ”¹ï¼Œæ— æ³•ä¿è¯å®‰å…¨

* å®¢æˆ·ç«¯
    * äºŒè¿›åˆ¶æ•°æ®(æ¶ˆè´¹Â¥10)ã€‚HASHç®—æ³•ï¼Œå¾—åˆ°HASHå€¼
    * HASHå€¼ï¼Œä½¿ç”¨å…¬é’¥é€šè¿‡RSAè¿›è¡ŒåŠ å¯†
    * å†æ¬¡æ‰“åŒ…åŠ å¯†(æ¶ˆè´¹Â¥10+HASHå€¼+å…¬é’¥åŠ å¯†åçš„æ•°æ®)å‘é€ã€‚

* æœåŠ¡ç«¯
    * è§£å¯†å¾—åˆ° (æ¶ˆè´¹Â¥10+HASHå€¼+å…¬é’¥åŠ å¯†åçš„æ•°æ®)
    * ç§é’¥è§£å¯†å–å‡ºHASHå€¼A
    * äºŒè¿›åˆ¶æ•°æ®(æ¶ˆè´¹Â¥10)ã€‚HASHç®—æ³•ï¼Œå¾—åˆ°HASHå€¼B
    * å¦‚æœA!=B è¯´æ˜æ•°æ®è¢«ç¯¡æ”¹ã€‚ä¸å¯ç”¨

### ä½çº§ç­¾å

* ç­¾å 
    * ä¸€ä¸ªäºŒè¿›åˆ¶çš„HASHå€¼è¿›è¡ŒRSAéå¯¹ç§°åŠ å¯†

![](https://fuqionglin-blog.oss-cn-qingdao.aliyuncs.com/%E6%BD%AD%E5%B7%9E/%E4%BB%A3%E7%A0%81%E7%AD%BE%E5%90%8D/02.jpg)

å¼€å‘å·¥å…·ï¼šMacç”µè„‘ --> ç”ŸæˆRSAå…¬é’¥M<csræ–‡ä»¶>ç§é’¥M
è‹¹æœæœåŠ¡å™¨ï¼šç§é’¥A
iPhoneï¼šå…¬é’¥A

* æµç¨‹
    * ç”µè„‘å°†å…¬é’¥Mä»¥åŠå¼€å‘è€…ä¿¡æ¯ä¼ åˆ°æœåŠ¡å™¨ è¯·æ±‚è¯ä¹¦çš„è¿‡ç¨‹ï¼Œé€šè¿‡csræ–‡ä»¶ç”³è¯·è¯ä¹¦
    * æœåŠ¡å™¨ç”Ÿæˆè¯ä¹¦ï¼šå¯¹å…¬é’¥Mè¿›è¡Œç­¾å è¯ä¹¦=ç§é’¥AåŠ å¯†å…¬é’¥Mçš„HASHå€¼+å…¬é’¥M
    * æœ¬åœ°ç”µè„‘æ‹¿åˆ°è¯ä¹¦å’Œç§é’¥Må…³è”<ç‚¹å¼€è¯ä¹¦ï¼Œä¸“ç”¨å¯†é’¥ï¼Œå¦‚æœåˆ«çš„ç”µè„‘éœ€è¦ç¼–è¯‘appã€‚æŠŠç§é’¥Mæ‰“æˆP12>
    * æœ¬åœ°appè£…å…¥æ‰‹æœº ç§é’¥Må¯¹APPäºŒè¿›åˆ¶çš„å“ˆå¸Œå€¼ç­¾å
    APPå¯æ‰§è¡Œæ–‡ä»¶åŒ…å«ï¼šä»£ç ã€APPç­¾åã€è¯ä¹¦
    * æ‰‹æœºéªŒè¯ æ‰‹æœºå–å‡ºappè¯ä¹¦ï¼Œå…¬é’¥Aè§£å¯†å¾—åˆ°å…¬é’¥Mï¼Œæ¯”å¯¹HASHå€¼ã€‚éªŒè¯è¯ä¹¦æ˜¯å¦åˆæ³•ã€‚æ‹¿å…¬é’¥Mè§£å¯†APPç­¾åã€‚åˆ¤æ–­APPæ˜¯å¦è¢«ä¿®æ”¹è¿‡

<pre><code class="language-objectivec">æŸ¥çœ‹è¯ä¹¦
$ cat CertificateSigningRequest.certSigningRequest
-----BEGIN CERTIFICATE REQUEST-----
MIICejCCAWICAQAwNTEXMBUGCSqGSIb3DQEJARYIYmVhci5jb20xDTALBgNVBAMM
BGJlYXIxCzAJBgNVBAYTAkNOMIIBIjANBgkqhkiG9w0BAQEFAAOCAQ8AMIIBCgKC
AQEAwEGOVNltfUUjpI/1MjCR8qsafh7Hyf8nGfpiQgeXYVZBtU/iWIjho+20a3kM
wJPzhukIRhNl01kf87oPbIB6CEsBy5k8ijG717v/ov8Nmi9kimb1lzXw0fEJWhZN
Nb8yajEDy1w8Gc9rUwYji9jXfqPK9bekCNz/P7NJBATIdp2HYmH1LSGEO6tTB5mN
gzHFqCHHdOebFmw0lsy7ZXQObZP34cWLkQxE6W6/4eBViBEb2p/rX4AEve7FQ6ON
k1TSTnGDAPArLstXOBO/2n1dNNrmYdI/NBwNrqgXdX9xF9AcoTbMsMDF3eOC1hDw
rQ5bukSlMrRWVSlEJCYPhPaZeQIDAQABoAAwDQYJKoZIhvcNAQELBQADggEBAELC
S8L9mElBMDyHMQdqK8hwbvWYzcViTH6kn8toYkFhWehHpf0Tu3tisu4S1TyJlzyW
f/Jum5qj0P1sbO5mKkKUu+iJKCMmcFilUDOzccZ/yIfOi+PjVhvFtFgh4KC95j9y
azacdbbzAeszNXwIEOw0+NvvyMOX9AeE94U8i7LjrDEybHuAQs61dSPKNL3xNqD5
oknLKKQ+KcAnRV7wieXNzyVKDzSIJWYl29/JCa5a3plWu4hhylowxlQg2EhBa3sG
Xjwnhjn3rqrA3KWriwbddetQRm16bnL7ccFQT12q/M+Ub/pUxGhWQNCapDLPIODs
PScodk1iopo+yWU2UR8=
-----END CERTIFICATE REQUEST-----

æŸ¥çœ‹è¯ä¹¦ä¿¡æ¯ï¼Œé™¤äº†æœ‰å…¬é’¥è¿˜æœ‰å…¶ä»–ä¿¡æ¯
$ openssl asn1parse -i -in CertificateSigningRequest.certSigningRequest
    0:d=0  hl=4 l= 634 cons: SEQUENCE
    4:d=1  hl=4 l= 354 cons:  SEQUENCE
    8:d=2  hl=2 l=   1 prim:   INTEGER           :00
   11:d=2  hl=2 l=  53 cons:   SEQUENCE
   13:d=3  hl=2 l=  23 cons:    SET
   15:d=4  hl=2 l=  21 cons:     SEQUENCE
   17:d=5  hl=2 l=   9 prim:      OBJECT            :emailAddress
   28:d=5  hl=2 l=   8 prim:      IA5STRING         :bear.com
   38:d=3  hl=2 l=  13 cons:    SET
   40:d=4  hl=2 l=  11 cons:     SEQUENCE
   42:d=5  hl=2 l=   3 prim:      OBJECT            :commonName
   47:d=5  hl=2 l=   4 prim:      UTF8STRING        :bear
   53:d=3  hl=2 l=  11 cons:    SET
   55:d=4  hl=2 l=   9 cons:     SEQUENCE
   57:d=5  hl=2 l=   3 prim:      OBJECT            :countryName
   62:d=5  hl=2 l=   2 prim:      PRINTABLESTRING   :CN
   66:d=2  hl=4 l= 290 cons:   SEQUENCE
   70:d=3  hl=2 l=  13 cons:    SEQUENCE
   72:d=4  hl=2 l=   9 prim:     OBJECT            :rsaEncryption//åŠ å¯†
   83:d=4  hl=2 l=   0 prim:     NULL
   85:d=3  hl=4 l= 271 prim:    BIT STRING
  360:d=2  hl=2 l=   0 cons:   cont [ 0 ]
  362:d=1  hl=2 l=  13 cons:  SEQUENCE
  364:d=2  hl=2 l=   9 prim:   OBJECT            :sha256WithRSAEncryption//å“ˆå¸Œç®—æ³•éªŒè¯
  375:d=2  hl=2 l=   0 prim:   NULL
  377:d=1  hl=4 l= 257 prim:  BIT STRING
</code></pre>

**ä¿è¯**å¼€å‘è€…çš„è®¤è¯å’Œç¨‹åºçš„å®‰å…¨æ€§

### ä»£ç ç­¾ååŸç†
* é¿å…å®‰è£…æ»¥ç”¨çš„é—®é¢˜ï¼ŒåŠ ä¸¤ä¸ªé™åˆ¶
    * é™åˆ¶è‹¹æœåå°æ³¨å†Œè¿‡çš„è®¾å¤‡æ‰å¯ä»¥å®‰è£…ï¼ŒUUIDã€è®¾å¤‡ä¿¡æ¯
    *  ç­¾ååªèƒ½é’ˆå¯¹æŸä¸€ä¸ªappç­¾å

* æè¿°æ–‡ä»¶ Provision profile
    * è®¾å¤‡IDs 
    * APPIDs
    * ENtitlements<æƒåˆ©æ–‡ä»¶ã€æˆæƒ>
    * å®‰è£…çš„æ—¶å€™ä¼šè·Ÿè¯ä¹¦ä¸€èµ·æ‰“åŒ…åˆ°app

<pre><code class="language-objectivec">//æ–‡ä»¶ä½ç½®
$ ï½/Library/MobileDevice/Provisioning Profiles

//æŸ¥çœ‹æè¿°æ–‡ä»¶
$ security cms -D -i 8b7156c1-ead4-424f-a402-f3fb5d0b3c2d.mobileprovision
XMLæ–‡ä»¶ï¼ŒåŠ å¯†çš„

TeamName å›¢é˜Ÿåç§°
ExpirationDate è¿‡æœŸæ—¶é—´
AppIDName appID 
CreationDate åˆ›å»ºæ—¶é—´
Name
DeveloperCerificates å¯¹åº”çš„è¯ä¹¦
ProvisionDevices å¯¹åº”çš„è®¾å¤‡
TimeToLive
ApplicationIdentifierPrefix
IsXcodeManaged
Platform
Version
UUID æè¿°æ–‡ä»¶æœ¬èº«UUID
TeamIdentifier
Entitlements
{
    get-task-allow æ˜¯å¦å…è®¸è°ƒè¯•
    TeamName
    appID
}
</code></pre>

* æè¿°æ–‡ä»¶åœ¨appåŒ…é‡Œé¢ã€‚æœ¬èº«ä¹Ÿæ˜¯ç­¾åè®¤è¯çš„æ— æ³•ç¯¡æ”¹
* CodeSignatureä»£ç ç­¾åä¿¡æ¯
* è¯ä¹¦ã€ç­¾åä¿¡æ¯åœ¨å¯æ‰§è¡Œæ–‡ä»¶é‡Œé¢

* æŸ¥çœ‹æè¿°æ–‡ä»¶ä¿¡æ¯:

<pre><code class="language-objectivec">$ security cms -D -i æè¿°æ–‡ä»¶è·¯å¾„
</code></pre>
    
### æ‰‹åŠ¨é‡ç­¾
* æŸ¥çœ‹APPçš„ç­¾åä¿¡æ¯
    
<pre><code class="language-objectivec">$ codesign -vv -d WeChat.app

Executable=~/Desktop/å¾®ä¿¡-6.6.5(è¶Šç‹±åº”ç”¨)/Payload/WeChat.app/WeChat
Identifier=com.tencent.xin
Format=app bundle with Mach-O universal (armv7 arm64)
CodeDirectory v=20200 size=503759 flags=0x0(none) hashes=15735+5 location=embedded
Signature size=4297
Authority=(unavailable)//æ²¡æœ‰ç­¾å
Info.plist=not bound
TeamIdentifier=88L2Q4487U
Sealed Resources version=2 rules=19 files=822
Internal requirements count=1 size=96
ç ¸è¿‡å£³ï¼Œç­¾åè¢«ç ´å
</code></pre>

* æŸ¥çœ‹æœ¬æœºæ‰€æœ‰è¯ä¹¦

<pre><code class="language-objectivec">$ security find-identity -v -p codesigning
</code></pre>

* æŸ¥çœ‹å¯æ‰§è¡Œæ–‡ä»¶çš„åŠ å¯†ä¿¡æ¯!

<pre><code class="language-objectivec">$ otool -l WeChat | grep crypt
</code></pre>
    
<pre><code class="language-objectivec">$ otool -l WeChat | grep crypt
     cryptoff 16384
    cryptsize 55164928
      cryptid 0//åŠ å¯†æ ‡è¯†
     cryptoff 16384
    cryptsize 59457536
      cryptid 0//åŠ å¯†æ ‡è¯†
</code></pre>



##### é‡ç­¾å:
* å¹²æ‰æ’ä»¶Pluginsæ–‡ä»¶å¤¹é‡Œé¢çš„å†…å®¹!
* Watch ç›´æ¥å¹²æ‰!
* å¯¹ Frameworks è¿›è¡Œç­¾å! codesign -fs "è¯ä¹¦" éœ€è¦ç­¾åçš„æ–‡ä»¶

<pre><code class="language-objectivec">$ codesign -fs "iPhone Developer: ...... (899ADDGV9B)" MMCommon.framework
</code></pre>

* ç»™å¯æ‰§è¡Œæ–‡ä»¶æ‰§è¡Œæƒé™! 

<pre><code class="language-objectivec">$chmod +x WeChat
</code></pre>

* æ‹·è´æè¿°æ–‡ä»¶
* ä¿®æ”¹info.plist çš„Bundle ID!
* ç”Ÿæˆplistçš„æƒé™æ–‡ä»¶ 

<pre><code class="language-objectivec">//æŸ¥çœ‹æƒé™
$ security cms -D -i embedded.mobileprovision
å…³æ³¨æƒé™å­—æ®µï¼ï¼ï¼
<&ltdict&gt>
		<&ltkey&gt>keychain-access-groups<&lt/key&gt>
		<&ltarray&gt>
			<&ltstring&gt>C7U6LL8RU9.*<&lt/string&gt>
		<&lt/array&gt>
		<&ltkey&gt>get-task-allow<&lt/key&gt>
		<&lttrue/&gt>
		<&ltkey&gt>application-identifier<&lt/key&gt>
		<&ltstring&gt>C7U6LL8RU9.*<&lt/string&gt>
		<&ltkey&gt>com.apple.developer.team-identifier<&lt/key&gt>
		<&ltstring&gt>C7U6LL8RU9<&lt/string&gt>
	<&lt/dict&gt>
</code></pre>

<pre><code class="language-objectivec">$ security cms -D -i embedded.mobileprovision
</code></pre>

* ç­¾åæ•´ä¸ªAPP!

<pre><code class="language-objectivec">$ codesign -fs "iPhone Developer: .... (899ADDGV9B)"  --no-strict --entitlements=en.plist WeChat.app
</code></pre>
	
9.æ‰“åŒ…å…¶å®å°±æ˜¯ä¸€ä¸ªzip

<pre><code class="language-objectivec">$ zip -ry WeChat.ipa Payload
</code></pre>


### åˆ©ç”¨Xcodeé‡ç­¾
* æ–°å»ºé¡¹ç›®ï¼ŒProductsä¸‹xxx.appï¼ŒShowinFinder
* æŠŠæ²¡æœ‰ç­¾åä¿¡æ¯çš„appæ”¾åˆ°ShowinFinderæ‰“å¼€çš„xxx.appä¸‹ï¼Œåå­—æ›¿æ¢ï¼Œåˆ æ‰xxx.app
* å¹²æ‰æ’ä»¶Pluginsæ–‡ä»¶å¤¹é‡Œé¢çš„å†…å®¹!
* Watch ç›´æ¥å¹²æ‰!
* å¯¹ Frameworks è¿›è¡Œç­¾å! 
* ä¿®æ”¹info.plist çš„Bundle ID!
* common + R

### è„šæœ¬åŒ–è‡ªåŠ¨é‡ç­¾
* æ–°å»ºé¡¹ç›®
* é¡¹ç›®ä¸‹æ–°å»ºAPPæ–‡ä»¶å¤¹ï¼ŒæŠŠipaä¸¢è¿›å»
* æ‰“å¼€Build Phases --> New Run Script Phase,æ·»åŠ è„šæœ¬

```
# ${SRCROOT} ä¸ºå·¥ç¨‹æ–‡ä»¶æ‰€åœ¨çš„ç›®å½•
TEMP_PATH="${SRCROOT}/Temp"
#èµ„æºæ–‡ä»¶å¤¹,æ”¾ä¸‰æ–¹APPçš„
ASSETS_PATH="${SRCROOT}/APP"
#ipaåŒ…è·¯å¾„
TARGET_IPA_PATH="${ASSETS_PATH}/*.ipa"


#å­˜åœ¨çš„å…ˆåˆ é™¤
rm -rf "$TEMP_PATH"
#æ–°å»ºTempæ–‡ä»¶å¤¹
mkdir -p "$TEMP_PATH"

# --------------------------------------
# 1. è§£å‹IPA åˆ°Tempä¸‹
unzip -oqq "$TARGET_IPA_PATH" -d "$TEMP_PATH"
# æ‹¿åˆ°è§£å‹çš„ä¸´æ—¶APPçš„è·¯å¾„
TEMP_APP_PATH=$(set -- "$TEMP_PATH/Payload/"*.app;echo "$1")
# è¿™é‡Œæ˜¾ç¤ºæ‰“å°ä¸€ä¸‹ TEMP_APP_PATHå˜é‡
echo "TEMP_APP_PATH: $TEMP_APP_PATH"

# -------------------------------------
# 2. æŠŠè§£å‹å‡ºæ¥çš„.appæ‹·è´è¿›å»
#BUILT_PRODUCTS_DIR å·¥ç¨‹ç”Ÿæˆçš„APPåŒ…è·¯å¾„
#TARGET_NAME targetåç§°
TARGET_APP_PATH="$BUILT_PRODUCTS_DIR/$TARGET_NAME.app"
echo "TARGET_APP_PATH: $TARGET_APP_PATH"

rm -rf "$TARGET_APP_PATH"
mkdir -p "$TARGET_APP_PATH"
cp -rf "$TEMP_APP_PATH/" "$TARGET_APP_PATH/"

# -------------------------------------
# 3. ä¸ºäº†æ˜¯é‡ç­¾è¿‡ç¨‹ç®€åŒ–ï¼Œç§»èµ°extensionå’ŒwatchAPP. æ­¤å¤–ä¸ªäººå…è´¹çš„è¯ä¹¦æ²¡åŠæ³•ç­¾extension

echo "Removing AppExtensions"
rm -rf "$TARGET_APP_PATH/PlugIns"
rm -rf "$TARGET_APP_PATH/Watch"

# -------------------------------------
# 4. æ›´æ–° Info.plist é‡Œçš„BundleId
#  è®¾ç½® "Set :KEY Value" "ç›®æ ‡æ–‡ä»¶è·¯å¾„.plist"
/usr/libexec/PlistBuddy -c "Set :CFBundleIdentifier $PRODUCT_BUNDLE_IDENTIFIER" "$TARGET_APP_PATH/Info.plist"

# 5.ç»™å¯æ‰§è¡Œæ–‡ä»¶ä¸Šæƒé™
#æ·»åŠ ipaäºŒè¿›åˆ¶çš„æ‰§è¡Œæƒé™,å¦åˆ™xcodeä¼šå‘ŠçŸ¥æ— æ³•è¿è¡Œ
#è¿™ä¸ªæ“ä½œæ˜¯è¦æ‰¾åˆ°ç¬¬ä¸‰æ–¹appåŒ…é‡Œçš„å¯æ‰§è¡Œæ–‡ä»¶åç§°ï¼Œå› ä¸ºinfo.plistçš„ 'Executable file' keyå¯¹åº”çš„æ˜¯å¯æ‰§è¡Œæ–‡ä»¶çš„åç§°
#æˆ‘ä»¬grep ä¸€ä¸‹,ç„¶åå–æœ€åä¸€è¡Œ, ç„¶åä»¥cut å‘½ä»¤åˆ†å‰²ï¼Œå–å‡ºæƒ³è¦çš„å…³é”®ä¿¡æ¯ã€‚å­˜åˆ°APP_BINARYå˜é‡é‡Œ
APP_BINARY=`plutil -convert xml1 -o - $TARGET_APP_PATH/Info.plist|grep -A1 Exec|tail -n1|cut -f2 -d\>|cut -f1 -d\<`


#è¿™ä¸ªä¸ºäºŒè¿›åˆ¶æ–‡ä»¶åŠ ä¸Šå¯æ‰§è¡Œæƒé™ +X
chmod +x "$TARGET_APP_PATH/$APP_BINARY"



# -------------------------------------
# 6. é‡ç­¾ç¬¬ä¸‰æ–¹app Frameworksä¸‹å·²å­˜åœ¨çš„åŠ¨æ€åº“
TARGET_APP_FRAMEWORKS_PATH="$TARGET_APP_PATH/Frameworks"
if [ -d "$TARGET_APP_FRAMEWORKS_PATH" ];
then
#éå†å‡ºæ‰€æœ‰åŠ¨æ€åº“çš„è·¯å¾„
for FRAMEWORK in "$TARGET_APP_FRAMEWORKS_PATH/"*
do
echo "ğŸºğŸºğŸºğŸºğŸºğŸºFRAMEWORK : $FRAMEWORK"
#ç­¾å --forceå¼ºåˆ¶ç­¾å
/usr/bin/codesign --force --sign "$EXPANDED_CODE_SIGN_IDENTITY" "$FRAMEWORK"
done
fi

```


