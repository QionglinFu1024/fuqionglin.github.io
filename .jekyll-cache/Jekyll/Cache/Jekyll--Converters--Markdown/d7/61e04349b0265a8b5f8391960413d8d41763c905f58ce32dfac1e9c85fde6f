I"‚p<h3 id="è§†é¢‘å½•åˆ¶å®ç°">è§†é¢‘å½•åˆ¶å®ç°</h3>

<ul>
  <li>å…³äºQuckTime
    <ul>
      <li>è§†é¢‘å†…å®¹çš„æ•æ‰ï¼šå½“è®¾ç½®æ•æ‰ä¼šè¯æ—¶ï¼Œæ·»åŠ ä¸€ä¸ªåä¸ºAVCaptureMovieFileOutputçš„è¾“å‡ºã€‚è¿™ä¸ªç±»å®šä¹‰äº†æ–¹æ³•å°†QuckTimeå½±ç‰‡æ•æ‰åˆ°ç£ç›˜ã€‚è¿™ä¸ªç±»å¤§å¤šæ•°æ ¸å¿ƒåŠŸèƒ½ç»§æ‰¿äºçˆ¶ç±»AVCaptureFileOutputã€‚è¿™ä¸ªçˆ¶ç±»å®šä¹‰äº†è®¸å¤šå®ç”¨åŠŸèƒ½ï¼Œæ¯”å¦‚å½•åˆ¶åˆ°æœ€é•¿æ—¶é™æˆ–å½•åˆ¶åˆ°ç‰¹å®šæ–‡ä»¶å¤§å°æ—¶ä¸ºæ­¢ã€‚è¿˜å¯ä»¥é…ç½®æˆä¿ç•™æœ€å°å¯ç”¨çš„ç£ç›˜ç©ºé—´ï¼Œè¿™ä¸€ç‚¹åœ¨å­˜å‚¨ç©ºé—´æœ‰é™çš„ç§»åŠ¨è®¾å¤‡ä¸Šå½•åˆ¶è§†é¢‘æ—¶éå¸¸é‡è¦</li>
      <li>é€šå¸¸å½“QuckTimeå½±ç‰‡å‡†å¤‡å‘å¸ƒæ—¶ï¼Œå½±ç‰‡å¤´çš„å…ƒæ•°æ®å¤„äºæ–‡ä»¶çš„å¼€å§‹ä½ç½®ã€‚è¿™æ ·å¯ä»¥è®©é‚£ä¸ªè§†é¢‘æ’­æ”¾å™¨å¿«é€Ÿè¯»å–å¤´åŒ…å«ä¿¡æ¯ï¼Œæ¥ç¡®å®šæ–‡ä»¶çš„å†…å®¹ã€ç»“æ„å’Œå…¶åŒ…å«çš„å¤šä¸ªæ ·æœ¬çš„ä½ç½®ã€‚ä¸è¿‡ï¼Œå½“å½•åˆ¶ä¸€ä¸ªQuckTimeå½±ç‰‡æ—¶ï¼Œç›´åˆ°æ‰€æœ‰çš„æ ·ç‰‡éƒ½å®Œæˆæ•æ‰åæ‰èƒ½åˆ›å»ºä¿¡æ¯å¤´ã€‚å½“å½•åˆ¶ç»“æŸæ—¶ï¼Œåˆ›å»ºå¤´æ•°æ®å¹¶å°†å®ƒé™„åœ¨æ–‡ä»¶ç»“å°¾å¤„ã€‚</li>
    </ul>

    <p><img src="https://fuqionglin-blog.oss-cn-qingdao.aliyuncs.com/%E6%BD%AD%E5%B7%9E/AVFoundation/20191202-01.jpg" alt="" /></p>

    <ul>
      <li>å°†åˆ›å»ºå¤´è¿‡ç¨‹æ”¾åœ¨æ‰€æœ‰å½±ç‰‡æ ·æœ¬å®Œæˆæ•æ‰ä¹‹åå­˜åœ¨ä¸€ä¸ªé—®é¢˜ï¼Œå°¤å…¶æ˜¯åœ¨ç§»åŠ¨è®¾å¤‡çš„æƒ…å†µä¸‹ã€‚å¦‚æœé‡åˆ°å´©æºƒæˆ–è€…å…¶ä»–ä¸­æ–­ï¼Œæ¯”å¦‚ç”µè¯æ‹¨å…¥ï¼Œåˆ™å½±ç‰‡å¤´å°±ä¸ä¼šè¢«æ­£ç¡®å†™å…¥ï¼Œä¼šåœ¨ç£ç›˜ç”Ÿæˆä¸€ä¸ªä¸å¯è¯»çš„å½±ç‰‡æ–‡ä»¶ã€‚AVCaptureMovieFileOutputæä¾›ä¸€ä¸ªæ ¸å¿ƒåŠŸèƒ½å°±æ˜¯åˆ†æ®µæ•æ‰QuickTimeå½±ç‰‡ã€‚</li>
    </ul>

    <p><img src="https://fuqionglin-blog.oss-cn-qingdao.aliyuncs.com/%E6%BD%AD%E5%B7%9E/AVFoundation/20191202-02.jpg" alt="" /></p>
  </li>
</ul>

<pre><code class="language-objectivec">#pragma mark - Video Capture Methods æ•æ‰è§†é¢‘

//åˆ¤æ–­æ˜¯å¦å½•åˆ¶çŠ¶æ€
- (BOOL)isRecording {
    return self.movieOutput.isRecording;
}

//å¼€å§‹å½•åˆ¶
- (void)startRecording {

    if (![self isRecording]) {
        
        //è·å–å½“å‰è§†é¢‘æ•æ‰è¿æ¥ä¿¡æ¯ï¼Œç”¨äºæ•æ‰è§†é¢‘æ•°æ®é…ç½®ä¸€äº›æ ¸å¿ƒå±æ€§
        AVCaptureConnection * videoConnection = [self.movieOutput connectionWithMediaType:AVMediaTypeVideo];
        
        //åˆ¤æ–­æ˜¯å¦æ”¯æŒè®¾ç½®videoOrientation å±æ€§ã€‚
        if([videoConnection isVideoOrientationSupported])
        {
            //æ”¯æŒåˆ™ä¿®æ”¹å½“å‰è§†é¢‘çš„æ–¹å‘
            videoConnection.videoOrientation = [self currentVideoOrientation];
        }
        
        //åˆ¤æ–­æ˜¯å¦æ”¯æŒè§†é¢‘ç¨³å®š å¯ä»¥æ˜¾è‘—æé«˜è§†é¢‘çš„è´¨é‡ã€‚åªä¼šåœ¨å½•åˆ¶è§†é¢‘æ–‡ä»¶æ¶‰åŠ
        if([videoConnection isVideoStabilizationSupported])
        {
            videoConnection.enablesVideoStabilizationWhenAvailable = YES;
        }
        
        AVCaptureDevice *device = [self activeCamera];
        
        //æ‘„åƒå¤´å¯ä»¥è¿›è¡Œå¹³æ»‘å¯¹ç„¦æ¨¡å¼æ“ä½œã€‚å³å‡æ…¢æ‘„åƒå¤´é•œå¤´å¯¹ç„¦é€Ÿåº¦ã€‚å½“ç”¨æˆ·ç§»åŠ¨æ‹æ‘„æ—¶æ‘„åƒå¤´ä¼šå°è¯•å¿«é€Ÿè‡ªåŠ¨å¯¹ç„¦ã€‚
        if (device.isSmoothAutoFocusEnabled) {
            NSError *error;
            if ([device lockForConfiguration:&amp;error]) {
                
                device.smoothAutoFocusEnabled = YES;
                [device unlockForConfiguration];
            }else
            {
                [self.delegate deviceConfigurationFailedWithError:error];
            }
        }
        
        //æŸ¥æ‰¾å†™å…¥æ•æ‰è§†é¢‘çš„å”¯ä¸€æ–‡ä»¶ç³»ç»ŸURL.
        self.outputURL = [self uniqueURL];
        
        //å¼€å§‹å½•åˆ¶ã€‚ç›´æ’­/å°è§†é¢‘ ---&gt; æ•æ‰åˆ°è§†é¢‘ä¿¡æ¯ ---&gt; å‹ç¼©(AAC/H264)
        //å½•åˆ¶æˆä¸€ä¸ªQuckTimeè§†é¢‘æ–‡ä»¶ --&gt; å­˜å‚¨åˆ°ç›¸å†Œã€‚(ä¹Ÿæ¶‰åŠåˆ°ç¼–ç --ç¡¬ç¼–ç --ç”±äºAVFoundationå·²ç»æ›¿ä½ å®Œæˆ)
        //åœ¨æ•æ‰è¾“å‡ºä¸Šè°ƒç”¨æ–¹æ³• å‚æ•°1:å½•åˆ¶ä¿å­˜è·¯å¾„  å‚æ•°2:ä»£ç†
        [self.movieOutput startRecordingToOutputFileURL:self.outputURL recordingDelegate:self];
    }
}

- (CMTime)recordedDuration {
    
    return self.movieOutput.recordedDuration;
}


//å†™å…¥è§†é¢‘å”¯ä¸€æ–‡ä»¶ç³»ç»ŸURL
- (NSURL *)uniqueURL {

    NSFileManager *fileManager = [NSFileManager defaultManager];
    
    //temporaryDirectoryWithTemplateString  å¯ä»¥å°†æ–‡ä»¶å†™å…¥çš„ç›®çš„åˆ›å»ºä¸€ä¸ªå”¯ä¸€å‘½åçš„ç›®å½•ï¼›
    //ä¸´æ—¶æ–‡ä»¶ï¼Œæ²¡ä¸‹è½½å®Œæˆå‰æ˜¯æ²¡æœ‰åç¼€åçš„ï¼Œä¸‹è½½å®Œæˆåæ‰ä¼šå˜æˆæ­£ç¡®çš„åç¼€å
    NSString *dirPath = [fileManager temporaryDirectoryWithTemplateString:@"kamera.XXXXXX"];
    
    if (dirPath) {
        //mov.è§†é¢‘å°è£…çš„å®¹å™¨ã€‚å’Œè§†é¢‘ç¼–ç æ ¼å¼æœ‰åŒºåˆ«
        NSString *filePath = [dirPath stringByAppendingPathComponent:@"kamera_movie.mov"];
        return  [NSURL fileURLWithPath:filePath];
        
    }
    
    return nil;
    
}

//åœæ­¢å½•åˆ¶
- (void)stopRecording {

    //æ˜¯å¦æ­£åœ¨å½•åˆ¶
    if ([self isRecording]) {
        [self.movieOutput stopRecording];
    }
}
</code></pre>

<h3 id="è§†é¢‘æ‹æ‘„ç¼©ç•¥å›¾å®ç°">è§†é¢‘æ‹æ‘„ç¼©ç•¥å›¾å®ç°</h3>

<pre><code class="language-objectivec">#pragma mark - AVCaptureFileOutputRecordingDelegate æ•æ‰æ–‡ä»¶è¾“å‡º

- (void)captureOutput:(AVCaptureFileOutput *)captureOutput didFinishRecordingToOutputFileAtURL:(NSURL *)outputFileURL fromConnections:(NSArray *)connections error:(NSError *)error {

    //é”™è¯¯
    if (error) {
        [self.delegate mediaCaptureFailedWithError:error];
    }else
    {
        //å†™å…¥
        [self writeVideoToAssetsLibrary:[self.outputURL copy]];
        
    }
    self.outputURL = nil;
}

//å†™å…¥æ•æ‰åˆ°çš„è§†é¢‘åˆ°ç›¸å†Œ
- (void)writeVideoToAssetsLibrary:(NSURL *)videoURL {
    
    //ALAssetsLibrary å®ä¾‹ æä¾›å†™å…¥è§†é¢‘çš„æ¥å£
    ALAssetsLibrary *library = [[ALAssetsLibrary alloc]init];
    
    //å†™èµ„æºåº“å†™å…¥å‰ï¼Œæ£€æŸ¥è§†é¢‘æ˜¯å¦å¯è¢«å†™å…¥ ï¼ˆå†™å…¥å‰å°½é‡å…»æˆåˆ¤æ–­çš„ä¹ æƒ¯ï¼‰
    if ([library videoAtPathIsCompatibleWithSavedPhotosAlbum:videoURL]) {
        
        //åˆ›å»ºblockå—
        ALAssetsLibraryWriteVideoCompletionBlock completionBlock;
        completionBlock = ^(NSURL *assetURL,NSError *error)
        {
            if (error) {
                [self.delegate assetLibraryWriteFailedWithError:error];
            }else
            {
                //ç”¨äºç•Œé¢å±•ç¤ºè§†é¢‘ç¼©ç•¥å›¾
                [self generateThumbnailForVideoAtURL:videoURL];
            }
            
        };
        
        //æ‰§è¡Œå®é™…å†™å…¥èµ„æºåº“çš„åŠ¨ä½œ
        [library writeVideoAtPathToSavedPhotosAlbum:videoURL completionBlock:completionBlock];
    }
}

//è·å–è§†é¢‘å·¦ä¸‹è§’ç¼©ç•¥å›¾
- (void)generateThumbnailForVideoAtURL:(NSURL *)videoURL {

    //åœ¨videoQueue ä¸Šï¼Œ
    dispatch_async(self.videoQueue, ^{
        
        //å»ºç«‹æ–°çš„AVAsset &amp; AVAssetImageGenerator
        AVAsset *asset = [AVAsset assetWithURL:videoURL];
        
        AVAssetImageGenerator *imageGenerator = [AVAssetImageGenerator assetImageGeneratorWithAsset:asset];
        
        //è®¾ç½®maximumSize å®½ä¸º100ï¼Œé«˜ä¸º0 æ ¹æ®è§†é¢‘çš„å®½é«˜æ¯”æ¥è®¡ç®—å›¾ç‰‡çš„é«˜åº¦
        imageGenerator.maximumSize = CGSizeMake(100.0f, 0.0f);
        
        //æ•æ‰è§†é¢‘ç¼©ç•¥å›¾ä¼šè€ƒè™‘è§†é¢‘çš„å˜åŒ–ï¼ˆå¦‚è§†é¢‘çš„æ–¹å‘å˜åŒ–ï¼‰ï¼Œå¦‚æœä¸è®¾ç½®ï¼Œç¼©ç•¥å›¾çš„æ–¹å‘å¯èƒ½å‡ºé”™
        imageGenerator.appliesPreferredTrackTransform = YES;
        
        //è·å–CGImageRefå›¾ç‰‡ æ³¨æ„éœ€è¦è‡ªå·±ç®¡ç†å®ƒçš„åˆ›å»ºå’Œé‡Šæ”¾
        CGImageRef imageRef = [imageGenerator copyCGImageAtTime:kCMTimeZero actualTime:NULL error:nil];
        
        //å°†å›¾ç‰‡è½¬åŒ–ä¸ºUIImage
        UIImage *image = [UIImage imageWithCGImage:imageRef];
        
        //é‡Šæ”¾CGImageRef imageRef é˜²æ­¢å†…å­˜æ³„æ¼
        CGImageRelease(imageRef);
        
        //å›åˆ°ä¸»çº¿ç¨‹
        dispatch_async(dispatch_get_main_queue(), ^{
            
            //å‘é€é€šçŸ¥ï¼Œä¼ é€’æœ€æ–°çš„image
            [self postThumbnailNotifification:image];
        });
    });
}
</code></pre>

<h3 id="iosä¸Šäººè„¸è¯†åˆ«çš„ç­–ç•¥åˆ†æ">iOSä¸Šäººè„¸è¯†åˆ«çš„ç­–ç•¥åˆ†æ</h3>

<ul>
  <li>æ¡†æ¶
    <ul>
      <li>CoreImage</li>
      <li>face++</li>
      <li>OpenCV</li>
      <li>libefacedetection</li>
      <li>AVFoundation</li>
      <li>vision</li>
    </ul>
  </li>
  <li>é™æ€äººè„¸è¯†åˆ«(è¯†åˆ«å›¾ç‰‡ä¸Šçš„äººè„¸)</li>
  <li>åŠ¨æ€äººè„¸è¯†åˆ«(è¯†åˆ«æ‹æ‘„è¿‡ç¨‹ä¸­çš„äººè„¸ï¼Œå®ç°æ¿€èŒæ•ˆæœ)</li>
  <li>è¯†åˆ«äºŒç»´ç </li>
</ul>

<p><img src="https://fuqionglin-blog.oss-cn-qingdao.aliyuncs.com/%E6%BD%AD%E5%B7%9E/AVFoundation/20191202-03.jpg" alt="" /></p>

<p><img src="https://fuqionglin-blog.oss-cn-qingdao.aliyuncs.com/%E6%BD%AD%E5%B7%9E/AVFoundation/20191202-04.jpg" alt="" /></p>

<h3 id="avfoundationäººè„¸è¯†åˆ«">AVFoundationäººè„¸è¯†åˆ«</h3>

<pre><code class="language-objectivec">- (BOOL)setupSessionOutputs:(NSError **)error {
    
    self.metadataOutput = [[AVCaptureMetadataOutput alloc]init];

    //ä¸ºæ•æ‰ä¼šè¯æ·»åŠ è®¾å¤‡
    if ([self.captureSession canAddOutput:self.metadataOutput]){
        [self.captureSession addOutput:self.metadataOutput];
        
        //è·å¾—äººè„¸å±æ€§
        NSArray *metadatObjectTypes = @[AVMetadataObjectTypeFace];
        //è®¾ç½®metadataObjectTypes æŒ‡å®šå¯¹è±¡è¾“å‡ºçš„å…ƒæ•°æ®ç±»å‹ã€‚
        /*
         é™åˆ¶æ£€æŸ¥åˆ°å…ƒæ•°æ®ç±»å‹é›†åˆçš„åšæ³•æ˜¯ä¸€ç§ä¼˜åŒ–å¤„ç†æ–¹æ³•ï¼ï¼å¯ä»¥å‡å°‘æˆ‘ä»¬å®é™…æ„Ÿå…´è¶£çš„å¯¹è±¡æ•°é‡
         æ”¯æŒå¤šç§å…ƒæ•°æ®ã€‚è¿™é‡Œåªä¿ç•™å¯¹äººè„¸å…ƒæ•°æ®æ„Ÿå…´è¶£
         */
        self.metadataOutput.metadataObjectTypes = metadatObjectTypes;
        
        //åˆ›å»ºä¸»é˜Ÿåˆ—ï¼š å› ä¸ºäººè„¸æ£€æµ‹ç”¨åˆ°äº†ç¡¬ä»¶åŠ é€ŸGPUï¼Œè€Œä¸”è®¸å¤šé‡è¦çš„ä»»åŠ¡éƒ½åœ¨ä¸»çº¿ç¨‹ä¸­æ‰§è¡Œï¼Œæ‰€ä»¥éœ€è¦ä¸ºè¿™æ¬¡å‚æ•°æŒ‡å®šä¸»é˜Ÿåˆ—ã€‚
        dispatch_queue_t mainQueue = dispatch_get_main_queue();
        
        //é€šè¿‡è®¾ç½®AVCaptureVideoDataOutputçš„ä»£ç†ï¼Œå°±èƒ½è·å–æ•è·åˆ°ä¸€å¸§ä¸€å¸§æ•°æ®
        [self.metadataOutput setMetadataObjectsDelegate:self queue:mainQueue];
     
        return YES;
    }else
    {
        //æŠ¥é”™
        if (error) {
            NSDictionary *userInfo = @{NSLocalizedDescriptionKey:@"Failed to still image output"};
            
            *error = [NSError errorWithDomain:THCameraErrorDomain code:THCameraErrorFailedToAddOutput userInfo:userInfo];
        }
        return NO;
    }
}


//ä»£ç†æ–¹æ³•=æ•è·åˆ°ä½ è®¾ç½®çš„å…ƒæ•°æ®å¯¹è±¡
- (void)captureOutput:(AVCaptureOutput *)captureOutput
didOutputMetadataObjects:(NSArray *)metadataObjects
       fromConnection:(AVCaptureConnection *)connection {

    //metadataObjects åŒ…å«äº†æ•è·åˆ°äººè„¸æ•°æ®.(äººè„¸æ•°æ®é‡å¤ï¼Œä¸Šä¸€ç§’æ•è·åˆ°çš„äººè„¸ä½ç½®ï¼Œä¸‹ä¸€ç§’è¿˜æ˜¯æ•è·)
    //ä½¿ç”¨å¾ªç¯ï¼Œæ‰“å°äººè„¸æ•°æ®
    for (AVMetadataFaceObject *face in metadataObjects) {
        //faceIDã€boundså”¯ä¸€ã€‚å“ªæ€•æ˜¯åŒèƒèƒ
        NSLog(@"Face detected with ID:%li",(long)face.faceID);
        NSLog(@"Face bounds:%@",NSStringFromCGRect(face.bounds));
    }
    //å·²ç»è·å–è§†é¢‘ä¸­çš„äººè„¸ä¸ªæ•°ï¼äººè„¸çš„eä½ç½®ï¼å¤„ç†äººè„¸ï¼é¢„è§ˆå›¾å±‚ä¸Š
    //å°†å…ƒæ•°æ® ä¼ é€’ç»™ THPreviewView.m   å°†å…ƒæ•°æ®è½¬æ¢ä¸ºlayer
    [self.faceDetectionDelegate didDetectFaces:metadataObjects];
}

/*
 1.è§†é¢‘é‡‡é›†
 2.ä¸ºsessionæ·»åŠ ä¸€ä¸ªå…ƒæ•°æ®çš„è¾“å‡º.ACCaptureMetadataOutput
 3.è®¾ç½®å…ƒæ•°æ®çš„èŒƒå›´(äººè„¸æ•°æ®ã€äºŒç»´ç æ•°æ®ã€ä¸€ç»´ç ...)
 4.å¼€å§‹æ•æ‰(è®¾ç½®æ•æ‰ä»£ç†)didOutPutMetadataObjects
 5.è·å–åˆ°æ•æ‰äººè„¸ç›¸å…³ä¿¡æ¯ï¼šä»£ç†æ–¹æ³•ä¸­å¯ä»¥è·å– didOutputMetadataObjects
 6.å¯¹äººè„¸æ•°æ®çš„å¤„ç†ï¼å°†äººè„¸æ¡†å‡ºæ¥ï¼(æ¶‰åŠæ¯”è¾ƒå¤šçš„ç»†èŠ‚)
*/
</code></pre>

<h3 id="yawpitchroll"><a href="http://blog.sina.com.cn/s/blog_8e6c5b220102wtpd.html">Yaw,Pitch,Roll</a></h3>

<ul>
  <li>æ¬§æ‹‰è§’æ˜¯ä»€ä¹ˆï¼Ÿ
    <ul>
      <li>æ¬§æ‹‰è§’æ˜¯ç”±3ä¸ªè§’ç»„æˆï¼Œè¿™3ä¸ªè§’åˆ†åˆ«æ˜¯yaw,Pitch,Rollã€‚å¾ˆéš¾ç¿»è¯‘è¿™3ä¸ªè¯ã€‚Yaw
è¡¨ç¤ºç»•Yè½´æ—‹è½¬çš„è§’åº¦ï¼ŒPitchè¡¨ç¤ºç»•Xè½´æ—‹è½¬è§’åº¦ï¼ŒRollè¡¨ç¤ºç»•Zè½´æ—‹è½¬çš„è§’åº¦ã€‚</li>
      <li>Yaw åç§»</li>
      <li>Pitch æŠ•æ·ã€å€¾æ–œã€å è½</li>
      <li>Roll è½¬åŠ¨</li>
    </ul>

    <p><img src="https://fuqionglin-blog.oss-cn-qingdao.aliyuncs.com/%E6%BD%AD%E5%B7%9E/AVFoundation/20191202-05.jpg" alt="" /></p>
  </li>
  <li>æ¬§æ‹‰è§’ä¸­çš„æ—‹è½¬
    <ul>
      <li>è¿™æ˜¯ç»•ç›¸å…³è½´æ—‹è½¬ï¼Œä¹˜ä»¥ç›¸å…³çŸ©é˜µå³å¯</li>
    </ul>

    <p><img src="https://fuqionglin-blog.oss-cn-qingdao.aliyuncs.com/%E6%BD%AD%E5%B7%9E/AVFoundation/20191202-06.jpg" alt="" /></p>
  </li>
</ul>

<pre><code class="language-objectivec">- (void)setupView {

    //åˆå§‹åŒ–faceLayerså±æ€§  å­—å…¸ï¼Œç”¨æ¥è®°å½•äººè„¸å›¾å±‚
    self.faceLayers = [NSMutableDictionary dictionary];
    
    //è®¾ç½®videoGravity ä½¿ç”¨AVLayerVideoGravityResizeAspectFill é“ºæ»¡æ•´ä¸ªé¢„è§ˆå±‚çš„è¾¹ç•ŒèŒƒå›´
    self.previewLayer.videoGravity = AVLayerVideoGravityResizeAspectFill;
    
    //åˆå§‹åŒ–overlayLayer
    self.overlayLayer = [CALayer layer];
    
    //è®¾ç½®å®ƒçš„frame
    self.overlayLayer.frame = self.bounds;
    //å‡è®¾ä½ çš„å›¾å±‚ä¸Šçš„å›¾å½¢å‘ç”Ÿ3Då˜æ¢ï¼Œè®¾ç½®æŠ•å½±æ–¹å¼
    //å­å›¾å±‚å½¢å˜ sublayerTransformå±æ€§   Core  AnimationåŠ¨ç”»
    self.overlayLayer.sublayerTransform = CATransform3DMakePerspective(1000);
    
    //å°†å­å›¾å±‚æ·»åŠ åˆ°é¢„è§ˆå›¾å±‚æ¥
    [self.previewLayer addSublayer:self.overlayLayer];
    
}

//å°†æ£€æµ‹åˆ°çš„äººè„¸è¿›è¡Œå¯è§†åŒ–
- (void)didDetectFaces:(NSArray *)faces {

    //äººè„¸æ•°æ®ä½ç½®ä¿¡æ¯(æ‘„åƒå¤´åæ ‡ç³») --&gt; å±å¹•åæ ‡ç³»
    //åˆ›å»ºä¸€ä¸ªæœ¬åœ°æ•°ç»„ ä¿å­˜è½¬æ¢åçš„äººè„¸æ•°æ®
    NSArray *transformedFaces = [self transformedFacesFromFaces:faces];
    
    //è·å–faceLayersçš„keyï¼Œç”¨äºç¡®å®šå“ªäº›äººç§»é™¤äº†è§†å›¾å¹¶å°†å¯¹åº”çš„å›¾å±‚ç§»å‡ºç•Œé¢ã€‚
    /*
        æ”¯æŒåŒæ—¶è¯†åˆ«10ä¸ªäººè„¸
     å¦‚æœè¿™ä¸ªäººè„¸ä»æ‘„åƒå¤´æ¶ˆå¤±äº†ï¼åˆ é™¤å®ƒçš„å›¾å±‚ faceID
     å…ˆå‡è®¾æ‰€æœ‰çš„äººè„¸éƒ½éœ€è¦åˆ é™¤ï¼Œç„¶åå†ä¸€ä¸€ä»åˆ é™¤åˆ—è¡¨ä¸­ç§»é™¤ï¼Œç›¸å½“äºä»é»‘åå•é‡Œé¢æ‹‰å‡ºæ¥
     */
    NSMutableArray *lostFaces = [self.faceLayers.allKeys mutableCopy];
    
    //éå†æ¯ä¸ªè½¬æ¢çš„äººè„¸å¯¹è±¡
    for (AVMetadataFaceObject *face in transformedFaces) {
        
        //è·å–å…³è”çš„faceIDã€‚è¿™ä¸ªå±æ€§å”¯ä¸€æ ‡è¯†ä¸€ä¸ªæ£€æµ‹åˆ°çš„äººè„¸
        NSNumber *faceID = @(face.faceID);
        //facaIDå­˜åœ¨ï¼äººè„¸æ²¡æœ‰ç§»yå‡ºæ‘„åƒå¤´ï¼Œä¸éœ€è¦åˆ é™¤
        //å°†å¯¹è±¡ä»lostFaces ç§»é™¤
        [lostFaces removeObject:faceID];
        
        //æ‹¿åˆ°å½“å‰faceIDå¯¹åº”çš„layerã€‚ old face
        CALayer *layer = self.faceLayers[faceID];
        
        //å¦‚æœç»™å®šçš„faceID æ²¡æœ‰æ‰¾åˆ°å¯¹åº”çš„å›¾å±‚ã€‚new face
        if (!layer) {
            
            //è°ƒç”¨makeFaceLayer åˆ›å»ºä¸€ä¸ªæ–°çš„äººè„¸å›¾å±‚
            layer = [self makeFaceLayer];
            
            //å°†æ–°çš„äººè„¸å›¾å±‚æ·»åŠ åˆ° overlayLayerä¸Š
            [self.overlayLayer addSublayer:layer];
            
            //å°†layeråŠ å…¥åˆ°å­—å…¸ä¸­
            self.faceLayers[faceID] = layer;
            
        }
        /*
         äººè„¸æ˜¯ç«‹ä½“çš„ 3D å±æ€§
         */
        //è®¾ç½®å›¾å±‚çš„transformå±æ€§ CATransform3DIdentity å›¾å±‚é»˜è®¤å˜åŒ– è¿™æ ·å¯ä»¥é‡æ–°è®¾ç½®ä¹‹å‰åº”ç”¨çš„å˜åŒ–
        layer.transform = CATransform3DIdentity;
        
        //æ ¹æ®äººè„¸çš„bounds è®¾ç½®layerçš„frame     å›¾å±‚çš„å¤§å° = äººè„¸çš„å¤§å°
        layer.frame = face.bounds;
        
        //åˆ¤æ–­äººè„¸å¯¹è±¡æ˜¯å¦å…·æœ‰æœ‰æ•ˆçš„æ–œå€¾äº¤ã€‚å¯ä»¥ç†è§£ä¸ºäººçš„å¤´éƒ¨å‘è‚©è†€æ–¹å‘jå€¾æ–œ
        if (face.hasRollAngle) {//Yawå³äººè„¸å·¦å³æ™ƒåŠ¨ï¼Œzè½´
            
            //å¦‚æœä¸ºYES,åˆ™è·å–ç›¸åº”çš„CATransform3D å€¼
            CATransform3D t = [self transformForRollAngle:face.rollAngle];
            //ä¸èƒ½ç›´æ¥è¦†ç›–ï¼Œè¦è¿æ¥èµ·æ¥ã€‚å³çŸ©é˜µç›¸ä¹˜
            //å°†å®ƒä¸æ ‡è¯†å˜åŒ–å…³è”åœ¨ä¸€èµ·ï¼Œå¹¶è®¾ç½®transformå±æ€§
            layer.transform = CATransform3DConcat(layer.transform, t);
        }
        
        
        //åˆ¤æ–­äººè„¸å¯¹è±¡æ˜¯å¦å…·æœ‰æœ‰æ•ˆçš„åè½¬è§’
        if (face.hasYawAngle) {//yè½´ï¼Œè¦è€ƒè™‘è®¾å¤‡æœ¬èº«è§’åº¦
            
            //å¦‚æœä¸ºYES,åˆ™è·å–ç›¸åº”çš„CATransform3D å€¼
            CATransform3D  t = [self transformForYawAngle:face.yawAngle];
            layer.transform = CATransform3DConcat(layer.transform, t);
            
        }
    }
    
    //å¤„ç†é‚£äº›å·²ç»ä»é•œå¤´ä¸­æ¶ˆå¤±çš„äººè„¸å›¾å±‚
    //äººè„¸å·²ç»æ¶ˆå¤±ï¼Œä½†æ˜¯å®ƒå¯¹åº”çš„å›¾å±‚å¹¶æ²¡æœ‰ä»ç•Œé¢ä¸Šéšä¹‹åˆ é™¤
    //éå†æ•°ç»„å°†å‰©ä¸‹çš„äººè„¸IDé›†åˆä»ä¸Šä¸€ä¸ªå›¾å±‚å’ŒfaceLayerså­—å…¸ä¸­ç§»é™¤
    for (NSNumber *faceID in lostFaces) {
        
        CALayer *layer = self.faceLayers[faceID];
        [layer removeFromSuperlayer];
        [self.faceLayers  removeObjectForKey:faceID];
    }
}


//å°†è®¾å¤‡çš„åæ ‡ç©ºé—´çš„äººè„¸è½¬æ¢ä¸ºè§†å›¾ç©ºé—´çš„å¯¹è±¡é›†åˆ
- (NSArray *)transformedFacesFromFaces:(NSArray *)faces {

    NSMutableArray *transformeFaces = [NSMutableArray array];
    
    for (AVMetadataObject *face in faces) {
        
        //å°†æ‘„åƒå¤´çš„äººè„¸æ•°æ® è½¬æ¢ä¸º è§†å›¾ä¸Šçš„å¯å±•ç¤ºçš„æ•°æ®
        //ç®€å•è¯´ï¼šUIKitçš„åæ ‡ ä¸ æ‘„åƒå¤´åæ ‡ç³»ç»Ÿï¼ˆ0ï¼Œ0ï¼‰-ï¼ˆ1ï¼Œ1ï¼‰ä¸ä¸€æ ·ã€‚æ‰€ä»¥éœ€è¦è½¬æ¢
        //è½¬æ¢éœ€è¦è€ƒè™‘å›¾å±‚ã€é•œåƒã€è§†é¢‘é‡åŠ›ã€æ–¹å‘ç­‰å› ç´  åœ¨iOS6.0ä¹‹å‰éœ€è¦å¼€å‘è€…è‡ªå·±è®¡ç®—ï¼Œä½†iOS6.0åæä¾›æ–¹æ³•
        AVMetadataObject *transformedFace = [self.previewLayer transformedMetadataObjectForMetadataObject:face];
        
        //è½¬æ¢æˆåŠŸåï¼ŒåŠ å…¥åˆ°æ•°ç»„ä¸­
        [transformeFaces addObject:transformedFace];
    }
    return transformeFaces;
}

- (CALayer *)makeFaceLayer {

    //åˆ›å»ºä¸€ä¸ªlayer
    CALayer *layer = [CALayer layer];
    
    //è¾¹æ¡†å®½åº¦ä¸º5.0f
    layer.borderWidth = 5.0f;
    
    //è¾¹æ¡†é¢œè‰²ä¸ºçº¢è‰²
    layer.borderColor = [UIColor redColor].CGColor;
    layer.contents = (id)[UIImage imageNamed:@"551.png"].CGImage;
    
    //è¿”å›layer
    return layer;
}



//å°† RollAngle çš„ rollAngleInDegrees å€¼è½¬æ¢ä¸º CATransform3D
- (CATransform3D)transformForRollAngle:(CGFloat)rollAngleInDegrees {

    //å°†äººè„¸å¯¹è±¡å¾—åˆ°çš„RollAngle å•ä½â€œåº¦â€ è½¬ä¸ºCore Animationéœ€è¦çš„å¼§åº¦å€¼
    CGFloat rollAngleInRadians = THDegreesToRadians(rollAngleInDegrees);

    //å°†ç»“æœèµ‹ç»™CATransform3DMakeRotation x,y,zè½´ä¸º0ï¼Œ0ï¼Œ1 å¾—åˆ°ç»•Zè½´å€¾æ–œè§’æ—‹è½¬è½¬æ¢
    return CATransform3DMakeRotation(rollAngleInRadians, 0.0f, 0.0f, 1.0f);
    //æœ€ç»ˆä¼šäº§ç”ŸçŸ©é˜µ
}


//å°† YawAngle çš„ yawAngleInDegrees å€¼è½¬æ¢ä¸º CATransform3D
- (CATransform3D)transformForYawAngle:(CGFloat)yawAngleInDegrees {

    //å°†è§’åº¦è½¬æ¢ä¸ºå¼§åº¦å€¼
     CGFloat yawAngleInRaians = THDegreesToRadians(yawAngleInDegrees);
    
    //å°†ç»“æœCATransform3DMakeRotation x,y,zè½´ä¸º0ï¼Œ-1ï¼Œ0 å¾—åˆ°ç»•Yè½´é€‰æ‹©ã€‚
    //ç”±äºoverlayer éœ€è¦åº”ç”¨sublayerTransformï¼Œæ‰€ä»¥å›¾å±‚ä¼šæŠ•å°„åˆ°zè½´ä¸Šï¼Œäººè„¸ä»ä¸€ä¾§è½¬å‘å¦ä¸€ä¾§ä¼šæœ‰3D æ•ˆæœ
    CATransform3D yawTransform = CATransform3DMakeRotation(yawAngleInRaians, 0.0f, -1.0f, 0.0f);
    
    //å› ä¸ºåº”ç”¨ç¨‹åºçš„ç•Œé¢å›ºå®šä¸ºå‚ç›´æ–¹å‘ï¼Œä½†éœ€è¦ä¸ºè®¾å¤‡æ–¹å‘è®¡ç®—ä¸€ä¸ªç›¸åº”çš„æ—‹è½¬å˜æ¢
    //å¦‚æœä¸è¿™æ ·ï¼Œä¼šé€ æˆäººè„¸å›¾å±‚çš„åè½¬æ•ˆæœä¸æ­£ç¡®
    
    return CATransform3DConcat(yawTransform, [self orientationTransform]);
}

- (CATransform3D)orientationTransform {
    //äººè„¸è ¢çš„æ•ˆæœä¸€èˆ¬å°±æ˜¯æ²¡æœ‰è€ƒè™‘è¿™ä¸ª
    CGFloat angle = 0.0;
    //æ‹¿åˆ°è®¾å¤‡æ–¹å‘
    switch ([UIDevice currentDevice].orientation) {
            
            //æ–¹å‘ï¼šä¸‹
        case UIDeviceOrientationPortraitUpsideDown:
            angle = M_PI;
            break;
            
            //æ–¹å‘ï¼šå³
        case UIDeviceOrientationLandscapeRight:
            angle = -M_PI / 2.0f;
            break;
        
            //æ–¹å‘ï¼šå·¦
        case UIDeviceOrientationLandscapeLeft:
            angle = M_PI /2.0f;
            break;

            //å…¶ä»–
        default:
            angle = 0.0f;
            break;
    }
    return CATransform3DMakeRotation(angle, 0.0f, 0.0f, 1.0f);
}

#pragma clang diagnostic push
#pragma clang diagnostic ignored "-Wunused"


static CGFloat THDegreesToRadians(CGFloat degrees) {

    return degrees * M_PI / 180;
}


static CATransform3D CATransform3DMakePerspective(CGFloat eyePosition) {
    
    //CATransform3D å›¾å±‚çš„æ—‹è½¬ï¼Œç¼©æ”¾ï¼Œåç§»ï¼Œæ­ªæ–œå’Œåº”ç”¨çš„é€
    //CATransform3DIdentityæ˜¯å•ä½çŸ©é˜µï¼Œè¯¥çŸ©é˜µæ²¡æœ‰ç¼©æ”¾ï¼Œæ—‹è½¬ï¼Œæ­ªæ–œï¼Œé€è§†ã€‚è¯¥çŸ©é˜µåº”ç”¨åˆ°å›¾å±‚ä¸Šï¼Œå°±æ˜¯è®¾ç½®é»˜è®¤å€¼ã€‚
    CATransform3D  transform = CATransform3DIdentity;
    
    //é€è§†æ•ˆæœï¼ˆå°±æ˜¯è¿‘å¤§è¿œå°ï¼‰ï¼Œæ˜¯é€šè¿‡è®¾ç½®m34 m34 = -1.0/D é»˜è®¤æ˜¯0.Dè¶Šå°é€è§†æ•ˆæœè¶Šæ˜æ˜¾
    //D:eyePosition è§‚å¯Ÿè€…åˆ°æŠ•å°„é¢çš„è·ç¦»
    transform.m34 = -1.0/eyePosition;
    
    return transform;
}
</code></pre>

<h3 id="avfoundationäºŒç»´ç è¯†åˆ«">AVFoundationäºŒç»´ç è¯†åˆ«</h3>

<ul>
  <li>äºŒç»´ç åˆ†ç±»
    <ul>
      <li>QRç : ç§»åŠ¨è¥é”€</li>
      <li>Aztecç : ç™»æœºç‰Œ</li>
      <li>PDF417: å•†å“è¿è¾“</li>
    </ul>
  </li>
  <li>é…ç½®ç›¸æœº</li>
</ul>

<pre><code class="language-objectivec">-(BOOL)setupSessionInputs:(NSError *__autoreleasing *)error {

    //è®¾ç½®ç›¸æœºè‡ªåŠ¨å¯¹ç„¦ï¼Œè¿™æ ·å¯ä»¥åœ¨ä»»ä½•è·ç¦»éƒ½å¯ä»¥è¿›è¡Œæ‰«æã€‚
    BOOL success = [super setupSessionInputs:error];
    if(success)
    {
        //åˆ¤æ–­æ˜¯å¦èƒ½è‡ªåŠ¨èšç„¦
        if (self.activeCamera.autoFocusRangeRestrictionSupported) {
            
            //é”å®šè®¾å¤‡
            if ([self.activeCamera lockForConfiguration:error]) {
                
                //è‡ªåŠ¨èšç„¦
                /*
                    iOS 7.0æ–°å¢å±æ€§ å…è®¸ä½¿ç”¨èŒƒå›´çº¦æŸæ¥å¯¹åŠŸèƒ½è¿›è¡Œå®šåˆ¶ã€‚
                  å› ä¸ºæ‰«ææ¡ç ï¼Œè·ç¦»éƒ½æ¯”è¾ƒè¿‘ã€‚æ‰€ä»¥AVCaptureAutoFocusRangeRestrictionNearï¼Œ
                 é€šè¿‡ç¼©å°è·ç¦»ï¼Œæ¥æé«˜è¯†åˆ«æˆåŠŸç‡ã€‚
                 */
                self.activeCamera.autoFocusRangeRestriction = AVCaptureAutoFocusRangeRestrictionNear;
                
                //é‡Šæ”¾æ’ä»–é”
                [self.activeCamera  unlockForConfiguration];
            }
        }
    }

    return YES;
}

-(BOOL)setupSessionOutputs:(NSError **)error {

    //è·å–è¾“å‡ºè®¾å¤‡
    self.metadataOutput = [[AVCaptureMetadataOutput alloc]init];
    
    //åˆ¤æ–­æ˜¯å¦èƒ½æ·»åŠ è¾“å‡ºè®¾å¤‡
    if ([self.captureSession canAddOutput:self.metadataOutput]) {
        
        //æ·»åŠ è¾“å‡ºè®¾å¤‡
        [self.captureSession addOutput:self.metadataOutput];
        
        dispatch_queue_t mainQueue = dispatch_get_main_queue();
        
        //è®¾ç½®å§”æ‰˜ä»£ç†
        [self.metadataOutput setMetadataObjectsDelegate:self queue:mainQueue];
        
        //æŒ‡å®šæ‰«æå¯¹æ˜¯ORç  &amp; Aztec ç  (ç§»åŠ¨è¥é”€)
        NSArray *types = @[AVMetadataObjectTypeQRCode,AVMetadataObjectTypeAztecCode,AVMetadataObjectTypeDataMatrixCode,AVMetadataObjectTypePDF417Code];
        
        self.metadataOutput.metadataObjectTypes = types;
        
    }else
    {
        //é”™è¯¯æ—¶ï¼Œå­˜å‚¨é”™è¯¯ä¿¡æ¯
        NSDictionary *userInfo = @{NSLocalizedDescriptionKey:@"Faild to add metadata output."};
        *error = [NSError errorWithDomain:THCameraErrorDomain code:THCameraErrorFailedToAddOutput userInfo:userInfo];
        return NO;
    }
    return YES;
}


//å§”æ‰˜ä»£ç†å›æ‰ã€‚å¤„ç†æ¡ç 
-(void)captureOutput:(AVCaptureOutput *)captureOutput
didOutputMetadataObjects:(NSArray *)metadataObjects
       fromConnection:(AVCaptureConnection *)connection {
    
    if (metadataObjects.count &gt; 0) {
        
        NSLog(@"%@",metadataObjects[0]);
        
        /*
         &lt;AVMetadataMachineReadableCodeObject: 0x17002db20, type="org.iso.QRCode", bounds={ 0.4,0.4 0.1x0.2 }&gt;corners { 0.4,0.6 0.6,0.6 0.6,0.4 0.4,0.4 }, time 122373330766250, stringValue ""http://www.echargenet.com/portal/csService/html/app.html
         */
    }
    //è·å–äº†
    [self.codeDetectionDelegate didDetectCodes:metadataObjects];

}
</code></pre>

<ul>
  <li>å¤„ç†å›¾å±‚</li>
</ul>

<pre><code class="language-objectivec">- (void)setupView {

    //ä¿å­˜ä¸€ç»„è¡¨ç¤ºè¯†åˆ«ç¼–ç çš„å‡ ä½•ä¿¡æ¯å›¾å±‚ã€‚
    _codeLayers = [NSMutableDictionary dictionary];
    
    //è®¾ç½®å›¾å±‚çš„videoGravity å±æ€§ï¼Œä¿è¯å®½é«˜æ¯”åœ¨è¾¹ç•ŒèŒƒå›´ä¹‹å†…
    self.previewLayer.videoGravity = AVLayerVideoGravityResizeAspect;
    
}

//å…ƒæ•°æ®è½¬æ¢
- (void)didDetectCodes:(NSArray *)codes {
    
    //ä¿å­˜è½¬æ¢å®Œæˆçš„å…ƒæ•°æ®å¯¹è±¡
    NSArray *transformedCodes = [self transformedCodesFromCodes:codes];
    
    //ä»codeLayerså­—å…¸ä¸­è·å¾—keyï¼Œç”¨æ¥åˆ¤æ–­é‚£ä¸ªå›¾å±‚åº”è¯¥åœ¨æ–¹æ³•å°¾éƒ¨ç§»é™¤
    NSMutableArray *lostCodes = [self.codeLayers.allKeys mutableCopy];
    
    //éå†æ•°ç»„
    for (AVMetadataMachineReadableCodeObject *code in transformedCodes) {
        
        //è·å¾—code.stringValue
        NSString *stringValue = code.stringValue;
        
        if (stringValue) {
         
            [lostCodes removeObject:stringValue];
            
        }else
        {
            continue;
        }
        
        //æ ¹æ®å½“å‰çš„stringValue æŸ¥æ‰¾å›¾å±‚ã€‚
        NSArray *layers = self.codeLayers[stringValue];
        
        //å¦‚æœæ²¡æœ‰å¯¹åº”çš„ç±»ç›®
        if (!layers) {
            
            //æ–°å»ºå›¾å±‚ æ–¹ã€åœ†
            layers = @[[self makeBoundsLayer],[self makeCornersLayer]];
            
            //å°†å›¾å±‚ä»¥stringValue ä¸ºkey å­˜å…¥å­—å…¸ä¸­
            self.codeLayers[stringValue] = layers;
            
            //åœ¨é¢„è§ˆå›¾å±‚ä¸Šæ·»åŠ  å›¾å±‚0ã€å›¾å±‚1
            [self.previewLayer addSublayer:layers[0]];
            [self.previewLayer addSublayer:layers[1]];
        }
        
        //åˆ›å»ºä¸€ä¸ªå’Œå¯¹è±¡çš„boundså…³è”çš„ UIBezierPath
        //ç”»æ–¹æ¡†
        CAShapeLayer *boundsLayer = layers[0];
        boundsLayer.path = [self bezierPathForBounds:code.bounds].CGPath;
        
        //å¯¹äºcornersLayer æ„å»ºä¸€ä¸ªCGPath
        CAShapeLayer *cornersLayer = layers[1];
        cornersLayer.path = [self bezierPathForCorners:code.corners].CGPath;
    }
    
    //éå†lostCodes
    for (NSString *stringValue in lostCodes) {
        
        //å°†é‡Œé¢çš„æ¡ç›®å›¾å±‚ä» previewLayer ä¸­ç§»é™¤
        for (CALayer *layer in self.codeLayers[stringValue]) {
         
            [layer removeFromSuperlayer];
            
        }
        //æ•°ç»„æ¡ç›®ä¸­ä¹Ÿè¦ç§»é™¤
        [self.codeLayers removeObjectForKey:stringValue];
    }
    
}

- (NSArray *)transformedCodesFromCodes:(NSArray *)codes {

    
    NSMutableArray *transformedCodes = [NSMutableArray array];
    
    //éå†æ•°ç»„
    for (AVMetadataObject *code in codes) {
        
        //è®²è®¾å¤‡åæ ‡ç©ºé—´å…ƒæ•°æ®å¯¹è±¡ è½¬æ¢ä¸º è§†å›¾åæ ‡ç©ºé—´å¯¹è±¡
        AVMetadataObject *transformedCode = [self.previewLayer transformedMetadataObjectForMetadataObject:code];
        
        //å°†è½¬æ¢å¥½çš„æ•°æ® æ·»åŠ åˆ° æ•°ç»„ä¸­
        [transformedCodes addObject:transformedCode];
        
    }
    
    //è¿”å›å·²ç»å¤„ç†å¥½çš„æ•°æ®
    return transformedCodes;
}

- (UIBezierPath *)bezierPathForBounds:(CGRect)bounds {

    //ç»˜åˆ¶ä¸€ä¸ªæ–¹æ¡†
    return [UIBezierPath bezierPathWithOvalInRect:bounds];
    
}

//CAShapeLayer æ˜¯CALayer å­ç±»ï¼Œç”¨äºç»˜åˆ¶UIBezierPath  ç»˜åˆ¶boudnsçŸ©å½¢
- (CAShapeLayer *)makeBoundsLayer {

    CAShapeLayer *shapeLayer = [CAShapeLayer layer];
    shapeLayer.strokeColor = [[UIColor colorWithRed:0.95f green:0.75f blue:0.06f alpha:1.0f]CGColor];
    shapeLayer.fillColor = nil;
    shapeLayer.lineWidth = 4.0f;
    return shapeLayer;

}

//CAShapeLayer æ˜¯CALayer å­ç±»ï¼Œç”¨äºç»˜åˆ¶UIBezierPath  ç»˜åˆ¶conersè·¯å¾„
- (CAShapeLayer *)makeCornersLayer {

    CAShapeLayer *cornerLayer = [CAShapeLayer layer];
    cornerLayer.lineWidth = 2.0f;
    cornerLayer.strokeColor  = [UIColor colorWithRed:0.172f green:0.671f blue:0.48f alpha:1.000f].CGColor;
    cornerLayer.fillColor = [UIColor colorWithRed:0.190f green:0.753f blue:0.489f alpha:0.5f].CGColor;
    
    return cornerLayer;
}

- (UIBezierPath *)bezierPathForCorners:(NSArray *)corners {
    //åˆ›å»ºä¸€ä¸ªç©ºçš„UIBezierPath
    UIBezierPath *path = [UIBezierPath bezierPath];
    
    //éå†æ•°ç»„ä¸­çš„æ¡ç›®ï¼Œä¸ºæ¯ä¸ªæ¡ç›®æ„å»ºä¸€ä¸ªCGPoint
     for (int i = 0; i &lt; corners.count; i++)
    {
        CGPoint point = [self pointForCorner:corners[i]];
        
        if (i == 0) {
            [path moveToPoint:point];
        }else
        {
            [path addLineToPoint:point];
        }
    }

    [path closePath];
    return  path;

}

//ä»å­—å…¸corner ä¸­æ‹¿åˆ°éœ€è¦çš„ç‚¹point
- (CGPoint)pointForCorner:(NSDictionary *)corner {

    CGPoint point;
    CGPointMakeWithDictionaryRepresentation((CFDictionaryRef)corner, &amp;point);
    return point;
}
</code></pre>

:ET