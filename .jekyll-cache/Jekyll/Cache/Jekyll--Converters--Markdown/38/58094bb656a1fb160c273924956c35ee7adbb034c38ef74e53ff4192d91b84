I"Ü<h3 id="debugserver">debugserver</h3>

<pre><code class="language-objectivec">//Macä½ç½®
/Applications/Xcode.app/Contents/Developer/Platforms/iPhoneOS.platform/DeviceSupport/9.1/DeveloperDiskImage.dmg/usr/bin/debugserver
//æ‰‹æœºä½ç½®ï¼Œå¿…é¡»è¶Šç‹±æ‰çœ‹å¾—åˆ°ï¼Œé€šè¿‡Xcodeå®‰è£…ä¸Šå»çš„
Device/Developer/usr/bin
//æ‰‹æœºDeveloperæ–‡ä»¶ä¸‹æ˜¯åªè¯»çš„
//å¦‚æœæƒ³è°ƒè¯•è¶Šç‹±.ç”¨ç”µè„‘ä¸Šçš„LLDBé“¾æ¥è®¾å¤‡ä¸Šçš„debugserver
</code></pre>

<ul>
  <li>æ‰‹æœºä¸Šçš„debugserverå…ˆé“¾æ¥æŸä¸€ä¸ªAPPï¼Œæä¾›ä¸€ä¸ªç«¯å£ç»™å¤–é¢ã€‚LLDBå†é“¾æ¥debugserver</li>
</ul>

<pre><code class="language-objectivec">//è¿æ¥æ‰‹æœº
$ sh login.sh
$ cd /Developer/usr/bin/
$ ls
DTDeviceArbitration  XcodeDeviceMonitor  iprofiler
ScreenShotr	     debugserver	 xctest
//æŸ¥çœ‹ä½¿ç”¨æ–¹æ³•
$ ./debugserver
debugserver-@(#)PROGRAM:debugserver  PROJECT:debugserver-340.3.51.1
 for arm64.
Usage:
  debugserver host:port [program-name program-arg1 program-arg2 ...]
  debugserver /path/file [program-name program-arg1 program-arg2 ...]
  debugserver host:port --attach=&lt;pid&gt;
  debugserver /path/file --attach=&lt;pid&gt;
  debugserver host:port --attach=&lt;process_name&gt;
  debugserver /path/file --attach=&lt;process_name&gt;

//æ‰‹æœºç«¯è¿æ¥app
$ ./debugserver *:12346 -a WeChat
debugserver-@(#)PROGRAM:debugserver  PROJECT:debugserver-340.3.51.1
 for arm64.
Attaching to process WeChat...
Listening to port 12346 for a connection from *...

//Macç«¯
//è¿›å…¥lldb
$ lldb
//è¿æ¥debugserver.æ•²å®Œä»¥åç¨‹åºä¼šå¡ä½
//åšå®Œç«¯å£æ˜ å°„ä»¥åå¯ä»¥æŠŠ172.17.10.14æ”¹æˆlocalhost
$ process connect connect://172.17.10.14:12346
Process 516 stopped
* thread #1, stop reason = signal SIGSTOP
    frame #0: 0x000000019b0a4a40 libsystem_kernel.dylib`mach_msg_trap + 8
libsystem_kernel.dylib`mach_msg_trap:
-&gt;  0x19b0a4a40 &lt;+8&gt;: ret

libsystem_kernel.dylib`mach_msg_overwrite_trap:
    0x19b0a4a44 &lt;+0&gt;: mov    x16, #-0x20
    0x19b0a4a48 &lt;+4&gt;: svc    #0x80
    0x19b0a4a4c &lt;+8&gt;: ret
//è¿æ¥æˆåŠŸï¼Œæš‚åœçŠ¶æ€ï¼Œç¨‹åºå°±è¢«æ–­ä½çš„.
Target 0: (WeChat) stopped.
//continueä¸€ä¸‹
$ c
//é€€å‡º,appä¼šè¢«æ€æ‰
$ exit
</code></pre>

<h4 id="æ‰‹æœºç«¯">æ‰‹æœºç«¯</h4>

<ul>
  <li>debugserver è¿æ¥APP
$ debugserver *:ç«¯å£å· -a è¿›ç¨‹</li>
  <li><code class="language-plaintext highlighter-rouge">*:ç«¯å£å·</code>
    <ul>
      <li>ä½¿ç”¨æ‰‹æœºçš„æŸä¸ªç«¯å£æä¾›æœåŠ¡</li>
    </ul>
  </li>
  <li><code class="language-plaintext highlighter-rouge">-a è¿›ç¨‹</code>
    <ul>
      <li>è¿æ¥çš„APP (è¿›ç¨‹ID,è¿›ç¨‹åç§°â€“MachOæ–‡ä»¶çš„åç§°)</li>
    </ul>
  </li>
</ul>

<h3 id="å‘½ä»¤è¡Œå·¥å…·çš„æƒé™æ–‡ä»¶">å‘½ä»¤è¡Œå·¥å…·çš„æƒé™æ–‡ä»¶</h3>
<ul>
  <li>å¯¼å‡ºæƒé™æ–‡ä»¶</li>
</ul>

<pre><code class="language-objectivec">$ ldid -e å¯æ‰§è¡Œæ–‡ä»¶ &gt; æ–‡ä»¶åç§°.entitlement
</code></pre>

<ul>
  <li>ä¸¤ä¸ªå…³é”®å­—æ®µ/æƒé™</li>
</ul>

<pre><code class="language-objectivec">get-task-allow
task_for_pid-allow
</code></pre>

<ul>
  <li>ç­¾åæƒé™</li>
</ul>

<pre><code class="language-objectivec">$ldid -Sæƒé™æ–‡ä»¶ å¯æ‰§è¡Œæ–‡ä»¶
</code></pre>

<ul>
  <li>Developer/usr/binåªè¯»ã€‚ç›´æ¥æ”¾åœ¨usr/bin</li>
</ul>

<h3 id="åè°ƒè¯•ptrace">åè°ƒè¯•Ptrace</h3>

<ul>
  <li>process trace è¿›ç¨‹è·Ÿè¸ª</li>
  <li>æ­¤å‡½æ•°æä¾›äº†ä¸€ä¸ªè¿›ç¨‹ç›‘å¬æ§åˆ¶å¦å¤–ä¸€ä¸ªè¿›ç¨‹ï¼Œå¹¶ä¸”å¯ä»¥æ£€æµ‹è¢«æ§åˆ¶è¿›ç¨‹çš„å†…å®¹å’Œå¯„å­˜å™¨é‡Œé¢çš„æ•°æ®ï¼å®ƒå¯ä»¥ç”¨æ¥å®ç°æ–­ç‚¹è°ƒè¯•å’Œç³»ç»Ÿè°ƒç”¨è·Ÿè¸ªã€‚debugserverå°±æ˜¯ç”¨çš„å®ƒ</li>
  <li>iOSä¸­æ²¡æœ‰æä¾›ç›¸å…³çš„å¤´ï¼Œä¸æ˜¯ç§æœ‰apiï¼Œå¯ä»¥ä½¿ç”¨</li>
  <li>åˆ›å»ºmacåº”ç”¨å¯¼å…¥&lt;sys/ptrace.h&gt;,å¯¼å‡º</li>
</ul>

<pre><code class="language-objectivec">/*
     arg1:ptraceè¦åšçš„äº‹æƒ…
     arg2:è¦æ“ä½œè¿›ç¨‹çš„ID
     arg3(åœ°å€)
     arg4(æ•°æ®): å–å†³äºarg1
     PT_DENY_ATTACH æ‹’ç»è¿æ¥
     */
    ptrace(PT_DENY_ATTACH, 0, 0, 0);
    //Xcodeæ— æ³•è°ƒè¯•ã€‚debugserverä¹Ÿæ— æ³•è°ƒè¯•
</code></pre>

<h3 id="åptrace">åPtrace</h3>

<ul>
  <li>æ³¨å…¥åŠ¨æ€åº“</li>
</ul>

<pre><code class="language-objectivec">//  æ€ä¹ˆç ´?? è°ƒç”¨ ptrace(ç³»ç»Ÿå‡½æ•°??) ä¿ç•™å‡½æ•°ç¬¦å·
//  é‡æ–°ç»‘å®š!! -- fishHook



#import "injectCode.h"
#import "fishhook.h"
#import "MyPtraceHeader.h"

@implementation injectCode

//å®šä¹‰æŒ‡é’ˆ,ä¿å­˜åŸæ¥çš„å‡½æ•°åœ°å€
int (*ptrace_p)(int _request, pid_t _pid, caddr_t _addr, int _data);
//å®šä¹‰è‡ªå·±çš„å‡½æ•°
int myPtrace(int _request, pid_t _pid, caddr_t _addr, int _data){
    //ä¸æ˜¯æ‹’ç»è¿æ¥å°±ä¿ç•™
    if (_request != PT_DENY_ATTACH) {
        return ptrace_p(_request, _pid, _addr, _data);
    }
    //å¦‚æœæ˜¯æ‹’ç»åŠ è½½!ä¸äºˆç†ä¼š!!
    return 0;
}



+(void)load
{
//    NSLog(@"injectCodeæ¥äº†!!");
    //äº¤æ¢!
    struct rebinding ptraceBd;//fishhookçš„ç»‘å®šç»“æ„ä½“
    ptraceBd.name = "ptrace";//å‡½æ•°ç¬¦å·
    ptraceBd.replacement = myPtrace;//æ–°å‡½æ•°çš„åœ°å€
    ptraceBd.replaced = (void *)&ptrace_p;//åŸå§‹å‡½æ•°åœ°å€çš„æŒ‡é’ˆ
    //å¼„ä¸€ä¸ªæ•°ç»„,æ”¾fishhookçš„ç»‘å®šç»“æ„ä½“
    struct rebinding bindings[] = {ptraceBd};
    //fishHookçš„é‡ç»‘å®šå‡½æ•°!!
    rebind_symbols(bindings, 1);
}
</code></pre>

<h3 id="é€šè¿‡frameworké˜²æŠ¤è°ƒè¯•">é€šè¿‡frameworké˜²æŠ¤è°ƒè¯•</h3>

<ul>
  <li>
    <p>ç¬¬ä¸€ä¸ªè°ƒç”¨è‡ªå·±çš„åŠ¨æ€åº“</p>
  </li>
  <li>
    <p>å†åï¼šMachOï¼Œæ³¨å…¥å‘½ä»¤è¡Œå·¥å…·ï¼Œå®ç°åŸç†</p>
  </li>
</ul>

:ET